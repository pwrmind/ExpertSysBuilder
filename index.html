<!DOCTYPE html>
<html lang="ru" x-data="{ activeTab: 'editor' }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpertSys Builder - Среда разработки экспертных систем</title>
    <!-- Bootstrap 5 CSS (compact) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Brain.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brain.js/2.0.0-beta.24/browser.min.js"></script>
    <style>
        :root { --bs-font-sans-serif: 'Inter', sans-serif; --bs-body-font-size: 0.875rem; }
        .code-font { font-family: 'Roboto Mono', monospace; font-size: 0.8rem; }
        .compact .form-control, .compact .btn, .compact .input-group-text { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        .module-card { transition: all 0.2s; border-left: 4px solid #0d6efd; }
        .module-card:hover { transform: translateY(-2px); box-shadow: 0 .3rem .75rem rgba(0,0,0,.1); }
        .rule-badge { font-size: 0.7rem; }
        .nav-tabs .nav-link { font-size: 0.85rem; padding: 0.5rem 0.75rem; }
        .tab-pane { padding-top: 1rem; }
        .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
        .timeline { position: relative; padding-left: 20px; }
        .timeline-item { position: relative; margin-bottom: 15px; }
        .timeline-marker { position: absolute; left: -20px; top: 10px; width: 10px; height: 10px; border-radius: 50%; }
        .timeline-content { margin-left: 10px; }
    </style>
</head>
<body class="bg-light compact">
    <div class="container-fluid py-2">
        <div id="app" x-data="appData()" x-init="init()">
            <!-- Заголовок и навигация -->
            <header class="mb-3 border-bottom pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h4 mb-0"><i class="bi bi-cpu"></i> ExpertSys Builder</h1>
                        <small class="text-muted">Среда разработки экспертных систем с ИИ</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-info me-2" x-text="`Правил: ${knowledgeBase.rules.length}`"></span>
                        <span class="badge bg-success" x-text="`Фактов: ${knowledgeBase.facts.length}`"></span>
                    </div>
                </div>
                
                <ul class="nav nav-tabs mt-3">
                    <template x-for="tab in tabs" :key="tab.id">
                        <li class="nav-item">
                            <a class="nav-link" :class="{ 'active': activeTab === tab.id }" href="#" @click.prevent="activeTab = tab.id">
                                <i :class="tab.icon"></i> <span x-text="tab.name"></span>
                            </a>
                        </li>
                    </template>
                </ul>
            </header>

            <!-- Основное содержимое (модули) -->
            <main>
                <!-- Модуль редактора БЗ -->
                <div x-show="activeTab === 'editor'" class="tab-pane fade show active">
                    <div class="row g-3">
                        <!-- Колонка 1: Онтология -->
                        <div class="col-lg-4">
                            <div class="card module-card h-100">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-diagram-2"></i> Онтология (Классы)</h6>
                                    <button class="btn btn-sm btn-success" @click="addClass">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body p-2">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Имя класса</th>
                                                    <th>Атрибуты</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="cls in knowledgeBase.ontology" :key="cls.id">
                                                    <tr>
                                                        <td x-text="cls.id" class="fw-bold"></td>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm border-0 p-0" 
                                                                   x-model="cls.name" @change="saveData">
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-wrap gap-1">
                                                                <template x-for="(attr, idx) in cls.attributes" :key="idx">
                                                                    <span class="badge bg-secondary rule-badge" x-text="attr"></span>
                                                                </template>
                                                                <button class="btn btn-xs btn-outline-secondary" 
                                                                        @click="addAttribute(cls)">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-danger" @click="removeClass(cls)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Колонка 2: Правила -->
                        <div class="col-lg-4">
                            <div class="card module-card h-100">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-list-check"></i> Правила (IF-THEN)</h6>
                                    <button class="btn btn-sm btn-success" @click="addRule">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body p-2">
                                    <div class="accordion" id="rulesAccordion">
                                        <template x-for="(rule, index) in knowledgeBase.rules" :key="rule.id">
                                            <div class="accordion-item border-0 mb-2">
                                                <h6 class="accordion-header">
                                                    <button class="accordion-button collapsed py-1" type="button" 
                                                            data-bs-toggle="collapse" :data-bs-target="'#rule' + rule.id">
                                                        <span class="badge bg-primary me-2" x-text="'#' + rule.id"></span>
                                                        <small class="truncate" x-text="rule.if.join(' AND ') + ' → ' + rule.then"></small>
                                                    </button>
                                                </h6>
                                                <div :id="'rule' + rule.id" class="accordion-collapse collapse">
                                                    <div class="accordion-body p-2">
                                                        <div class="mb-2">
                                                            <label class="form-label small">Условие (IF):</label>
                                                            <div class="d-flex flex-wrap gap-1 mb-1">
                                                                <template x-for="(condition, idx) in rule.if" :key="idx">
                                                                    <div class="input-group input-group-sm" style="width: auto">
                                                                        <input type="text" class="form-control" x-model="rule.if[idx]" @change="saveData">
                                                                        <button class="btn btn-outline-danger" @click="removeCondition(rule, idx)">
                                                                            <i class="bi bi-x"></i>
                                                                        </button>
                                                                    </div>
                                                                </template>
                                                            </div>
                                                            <button class="btn btn-sm btn-outline-secondary" @click="addCondition(rule)">
                                                                <i class="bi bi-plus-circle"></i> Добавить условие
                                                            </button>
                                                        </div>
                                                        <div class="mb-2">
                                                            <label class="form-label small">Заключение (THEN):</label>
                                                            <input type="text" class="form-control form-control-sm" 
                                                                   x-model="rule.then" @change="saveData">
                                                        </div>
                                                        <div class="mb-2">
                                                            <label class="form-label small">
                                                                Достоверность: <span x-text="rule.confidence"></span>
                                                            </label>
                                                            <input type="range" class="form-range" min="0" max="1" step="0.05" 
                                                                   x-model="rule.confidence" @change="saveData">
                                                        </div>
                                                        <div class="d-flex justify-content-between">
                                                            <button class="btn btn-sm btn-danger" @click="removeRule(rule)">
                                                                <i class="bi bi-trash"></i> Удалить
                                                            </button>
                                                            <span class="text-muted small" x-text="'ID: ' + rule.id"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Колонка 3: Факты -->
                        <div class="col-lg-4">
                            <div class="card module-card h-100">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-card-checklist"></i> Факты</h6>
                                    <button class="btn btn-sm btn-success" @click="addFact">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body p-2">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Имя факта</th>
                                                    <th>Тип</th>
                                                    <th>Категория</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="fact in knowledgeBase.facts" :key="fact.id">
                                                    <tr>
                                                        <td x-text="fact.id" class="fw-bold"></td>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm border-0 p-0" 
                                                                   x-model="fact.name" @change="saveData">
                                                        </td>
                                                        <td>
                                                            <select class="form-select form-select-sm border-0" x-model="fact.type" @change="saveData">
                                                                <option value="симптом">Симптом</option>
                                                                <option value="диагноз">Диагноз</option>
                                                                <option value="действие">Действие</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <select class="form-select form-select-sm border-0" x-model="fact.category" @change="saveData">
                                                                <option value="аппаратный">Аппаратный</option>
                                                                <option value="программный">Программный</option>
                                                                <option value="сетевой">Сетевой</option>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-danger" @click="removeFact(fact)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модуль логического вывода -->
                <div x-show="activeTab === 'inference'" class="tab-pane fade">
                    <div class="row g-3">
                        <!-- Левая колонка: Ввод запроса -->
                        <div class="col-md-5">
                            <div class="card module-card">
                                <div class="card-header py-2">
                                    <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Ввод запроса</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">Выберите известные факты (симптомы):</label>
                                        <div class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto;">
                                            <template x-for="fact in knowledgeBase.facts" :key="fact.id">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" :id="'fact_' + fact.id" 
                                                           :value="fact.name" x-model="query.facts">
                                                    <label class="form-check-label small" :for="'fact_' + fact.id" 
                                                           x-text="fact.name + ' (' + fact.category + ')'"></label>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small">Или введите произвольные факты:</label>
                                        <div class="input-group input-group-sm mb-1">
                                            <input type="text" class="form-control" placeholder="новый_факт" 
                                                   x-model="newFactInput">
                                            <button class="btn btn-outline-primary" @click="addCustomFact">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                        <div class="d-flex flex-wrap gap-1">
                                            <template x-for="(fact, idx) in query.customFacts" :key="idx">
                                                <span class="badge bg-info">
                                                    <span x-text="fact"></span>
                                                    <button class="btn btn-xs p-0 ms-1" @click="removeCustomFact(idx)">
                                                        <i class="bi bi-x"></i>
                                                    </button>
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100" @click="runInference">
                                        <i class="bi bi-play-circle"></i> Запустить логический вывод
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Блок результатов -->
                            <div class="card module-card mt-3" x-show="result.conclusions.length > 0">
                                <div class="card-header py-2 bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-check-circle"></i> Результаты вывода</h6>
                                </div>
                                <div class="card-body">
                                    <h6 class="border-bottom pb-1">Найденные решения:</h6>
                                    <ul class="list-group list-group-flush">
                                        <template x-for="(conc, idx) in result.conclusions" :key="idx">
                                            <li class="list-group-item py-1 d-flex justify-content-between">
                                                <span x-text="conc.conclusion"></span>
                                                <span class="badge bg-success" x-text="'Вер. ' + conc.confidence"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Центральная колонка: Процесс вывода -->
                        <div class="col-md-7">
                            <div class="card module-card h-100">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-list-columns-reverse"></i> Процесс логического вывода</h6>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="showDetails" x-model="showInferenceDetails">
                                        <label class="form-check-label small" for="showDetails">Детали</label>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div x-show="!result.executed" class="text-center text-muted py-5">
                                        <i class="bi bi-arrow-left display-6"></i>
                                        <p class="mt-2">Введите факты и запустите вывод</p>
                                    </div>
                                    
                                    <div x-show="result.executed">
                                        <h6 class="border-bottom pb-1">Цепочка рассуждений:</h6>
                                        <div class="timeline mt-3">
                                            <template x-for="(step, idx) in result.chain" :key="idx">
                                                <div class="timeline-item mb-3">
                                                    <div class="timeline-marker bg-primary"></div>
                                                    <div class="timeline-content">
                                                        <div class="card">
                                                            <div class="card-body py-2">
                                                                <div class="d-flex justify-content-between">
                                                                    <small class="text-muted" 
                                                                           x-text="'Шаг ' + (idx + 1) + ' (Правило #' + step.ruleId + ')'"></small>
                                                                    <span class="badge bg-primary" 
                                                                          x-text="'Вер. ' + step.confidence"></span>
                                                                </div>
                                                                <div class="mt-1">
                                                                    <span class="fw-bold" x-text="'ЕСЛИ ' + step.conditions.join(' И ')"></span>
                                                                    <br>
                                                                    <span class="text-success" x-text="'ТО ' + step.conclusion"></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модуль нейросети (Brain.js) -->
                <div x-show="activeTab === 'neural'" class="tab-pane fade">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-header py-2">
                                    <h6 class="mb-0"><i class="bi bi-cpu"></i> Обучение нейросети (Brain.js)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">Тренировочные данные (JSON):</label>
                                        <textarea class="form-control code-font" rows="10" x-model="neuralTrainingData"></textarea>
                                        <small class="text-muted">Пример: [{"input": {"симптом1": 1}, "output": {"диагноз": 1}}]</small>
                                    </div>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <label class="form-label small">Эпох:</label>
                                            <input type="number" class="form-control form-control-sm" x-model="neuralConfig.iterations" min="100" max="10000">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label small">Скрытые слои:</label>
                                            <input type="text" class="form-control form-control-sm" value="[3]" x-model="neuralConfig.hiddenLayers">
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100 mt-3" @click="trainNeuralNetwork" :disabled="training">
                                        <i class="bi bi-play-fill"></i> 
                                        <span x-text="training ? 'Обучение...' : 'Обучить нейросеть'"></span>
                                    </button>
                                    
                                    <div class="mt-3" x-show="neuralResult">
                                        <div class="alert alert-success py-2">
                                            <h6 class="mb-1">Нейросеть обучена!</h6>
                                            <small x-text="'Ошибка: ' + neuralResult.error"></small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-header py-2">
                                    <h6 class="mb-0"><i class="bi bi-lightning-charge"></i> Тестирование нейросети</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">Входные данные для классификации:</label>
                                        <textarea class="form-control code-font" rows="5" x-model="neuralTestInput"></textarea>
                                    </div>
                                    <button class="btn btn-success w-100" @click="runNeuralNetwork" :disabled="!neuralNetwork">
                                        <i class="bi bi-gear"></i> Запустить классификацию
                                    </button>
                                    
                                    <div class="mt-3" x-show="neuralTestResult">
                                        <h6 class="border-bottom pb-1">Результаты классификации:</h6>
                                        <pre class="bg-light p-2 small" x-text="JSON.stringify(neuralTestResult, null, 2)"></pre>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <h6 class="border-bottom pb-1">Обученные сети:</h6>
                                        <div class="list-group list-group-flush">
                                            <template x-for="(net, idx) in neuralNetworks" :key="idx">
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <small x-text="'Сеть #' + (idx + 1)"></small>
                                                    <div>
                                                        <button class="btn btn-sm btn-outline-primary" @click="loadNetwork(net)">
                                                            <i class="bi bi-upload"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger" @click="removeNetwork(idx)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модуль импорта/экспорта -->
                <div x-show="activeTab === 'io'" class="tab-pane fade">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-header py-2 bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-download"></i> Экспорт базы знаний</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">Выберите формат экспорта:</label>
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-outline-primary active" data-format="json">JSON</button>
                                            <button class="btn btn-outline-primary" data-format="csv">CSV (факты)</button>
                                            <button class="btn btn-outline-primary" data-format="clips">CLIPS (правила)</button>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label small">Что экспортировать:</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="expAll" checked>
                                            <label class="form-check-label small" for="expAll">Всю базу знаний</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="expRules" checked>
                                            <label class="form-check-label small" for="expRules">Только правила</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="expFacts" checked>
                                            <label class="form-check-label small" for="expFacts">Только факты</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="expOntology" checked>
                                            <label class="form-check-label small" for="expOntology">Онтологию</label>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label small">Предпросмотр данных:</label>
                                        <pre class="bg-light p-2 small code-font" style="max-height: 200px; overflow: auto;" 
                                             x-text="exportPreview"></pre>
                                    </div>
                                    
                                    <button class="btn btn-success w-100" @click="exportData">
                                        <i class="bi bi-file-arrow-down"></i> Скачать файл экспорта
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-header py-2 bg-warning text-dark">
                                    <h6 class="mb-0"><i class="bi bi-upload"></i> Импорт базы знаний</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">Выберите файл для импорта:</label>
                                        <input type="file" class="form-control form-control-sm" id="importFile" 
                                               accept=".json,.csv,.txt" @change="handleFileSelect">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label small">Режим импорта:</label>
                                        <select class="form-select form-select-sm" x-model="importMode">
                                            <option value="replace">Заменить текущую БЗ</option>
                                            <option value="merge">Объединить с текущей</option>
                                            <option value="append">Добавить к текущей</option>
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="backupBeforeImport" checked>
                                            <label class="form-check-label small" for="backupBeforeImport">
                                                Создать резервную копию перед импортом
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-warning py-2 small" x-show="importStatus">
                                        <i class="bi bi-info-circle"></i> <span x-text="importStatus"></span>
                                    </div>
                                    
                                    <button class="btn btn-warning w-100" @click="importData" :disabled="!importFileData">
                                        <i class="bi bi-file-arrow-up"></i> Импортировать данные
                                    </button>
                                    
                                    <div class="mt-3">
                                        <h6 class="border-bottom pb-1">Быстрый импорт (примеры):</h6>
                                        <div class="d-flex flex-wrap gap-1 mt-2">
                                            <button class="btn btn-sm btn-outline-secondary" @click="loadExample('medical')">
                                                Медицинская диагностика
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" @click="loadExample('it')">
                                                IT-поддержка
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" @click="loadExample('legal')">
                                                Юридическая система
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card module-card mt-3">
                                <div class="card-header py-2 bg-info text-white">
                                    <h6 class="mb-0"><i class="bi bi-hdd"></i> Управление данными</h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" @click="saveData">
                                            <i class="bi bi-save"></i> Сохранить в LocalStorage
                                        </button>
                                        <button class="btn btn-outline-success" @click="loadFromStorage">
                                            <i class="bi bi-folder-symlink"></i> Загрузить из LocalStorage
                                        </button>
                                        <button class="btn btn-outline-danger" @click="clearData">
                                            <i class="bi bi-trash"></i> Очистить все данные
                                        </button>
                                    </div>
                                    <div class="mt-3 small text-muted">
                                        <i class="bi bi-info-circle"></i> Данные автоматически сохраняются при изменениях.
                                        Последнее сохранение: <span x-text="lastSaveTime"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модуль проекта и настроек -->
                <div x-show="activeTab === 'project'" class="tab-pane fade">
                    <h2 class="h5 mb-3"><i class="bi bi-folder"></i> Проект и настройки</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-info-circle"></i> Информация о проекте</h6>
                                    <div class="mb-2">
                                        <label class="form-label small">Название проекта</label>
                                        <input type="text" class="form-control form-control-sm" x-model="project.name">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small">Описание</label>
                                        <textarea class="form-control form-control-sm" rows="3" x-model="project.description"></textarea>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small">Предметная область</label>
                                        <input type="text" class="form-control form-control-sm" x-model="project.domain">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-graph-up"></i> Статистика</h6>
                                    <ul class="list-group list-group-flush small">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Правил в БЗ</span>
                                            <span class="badge bg-primary rounded-pill" x-text="knowledgeBase.rules.length"></span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Фактов в БЗ</span>
                                            <span class="badge bg-primary rounded-pill" x-text="knowledgeBase.facts.length"></span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Классов онтологии</span>
                                            <span class="badge bg-primary rounded-pill" x-text="knowledgeBase.ontology.length"></span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Обученных нейросетей</span>
                                            <span class="badge bg-primary rounded-pill" x-text="neuralNetworks.length"></span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    function appData() {
        return {
            // Активная вкладка
            activeTab: 'editor',
            
            // Вкладки навигации
            tabs: [
                { id: 'editor', name: 'Редактор БЗ', icon: 'bi bi-pencil-square' },
                { id: 'inference', name: 'Вывод', icon: 'bi bi-gear' },
                { id: 'neural', name: 'Нейросеть', icon: 'bi bi-diagram-3' },
                { id: 'io', name: 'Импорт/Экспорт', icon: 'bi bi-arrow-left-right' },
                { id: 'project', name: 'Проект', icon: 'bi bi-folder' }
            ],
            
            // Данные проекта
            project: {
                name: 'Моя экспертная система',
                description: 'Демонстрационный проект диагностики проблем с ПК',
                domain: 'IT-диагностика'
            },
            
            // База знаний
            knowledgeBase: {
                ontology: [
                    { id: 1, name: 'Компьютер', attributes: ['модель', 'состояние'] },
                    { id: 2, name: 'Проблема', attributes: ['тип', 'симптомы', 'срочность'] }
                ],
                rules: [
                    { id: 1, if: ['компьютер_не_включается'], then: 'проверить_питание', confidence: 0.9 },
                    { id: 2, if: ['синий_экран', 'перезагрузка'], then: 'проверить_оперативную_память', confidence: 0.85 }
                ],
                facts: [
                    { id: 1, name: 'компьютер_не_включается', type: 'симптом', category: 'аппаратный' },
                    { id: 2, name: 'синий_экран', type: 'симптом', category: 'программный' }
                ]
            },
            
            // Логический вывод
            query: {
                facts: [],
                customFacts: []
            },
            newFactInput: '',
            result: {
                executed: false,
                conclusions: [],
                chain: []
            },
            showInferenceDetails: true,
            
            // Нейросеть
            neuralTrainingData: `[
  {"input": {"компьютер_не_включается": 1}, "output": {"проблема_питания": 1}},
  {"input": {"синий_экран": 1, "перезагрузка": 1}, "output": {"проблема_памяти": 1}},
  {"input": {"медленная_работа": 1, "шум_диска": 1}, "output": {"проблема_жесткого_диска": 1}}
]`,
            neuralConfig: {
                iterations: 1000,
                hiddenLayers: '[3]'
            },
            neuralTestInput: '{"компьютер_не_включается": 1}',
            neuralNetwork: null,
            training: false,
            neuralResult: null,
            neuralTestResult: null,
            neuralNetworks: [],
            
            // Импорт/экспорт
            exportPreview: '',
            importFileData: null,
            importMode: 'replace',
            importStatus: '',
            lastSaveTime: 'только что',
            
            // Инициализация
            init() {
                console.log('ExpertSys Builder инициализирован');
                const saved = localStorage.getItem('expertSysData');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        Object.assign(this, data);
                    } catch(e) {
                        console.error('Ошибка загрузки:', e);
                    }
                }
                
                // Обновляем предпросмотр экспорта
                this.updateExportPreview();
                
                // Обновляем время последнего сохранения
                const lastSave = localStorage.getItem('expertSysLastSave');
                if (lastSave) this.lastSaveTime = lastSave;
            },
            
            // Методы
            // Работа с онтологией
            addClass() {
                const newId = Math.max(...this.knowledgeBase.ontology.map(c => c.id), 0) + 1;
                this.knowledgeBase.ontology.push({
                    id: newId,
                    name: 'НовыйКласс',
                    attributes: []
                });
                this.saveData();
            },
            
            removeClass(cls) {
                this.knowledgeBase.ontology = this.knowledgeBase.ontology.filter(c => c.id !== cls.id);
                this.saveData();
            },
            
            addAttribute(cls) {
                const attrName = prompt('Введите имя атрибута:');
                if (attrName && attrName.trim()) {
                    cls.attributes.push(attrName.trim());
                    this.saveData();
                }
            },
            
            // Работа с правилами
            addRule() {
                const newId = Math.max(...this.knowledgeBase.rules.map(r => r.id), 0) + 1;
                this.knowledgeBase.rules.push({
                    id: newId,
                    if: ['новое_условие'],
                    then: 'новое_заключение',
                    confidence: 0.8
                });
                this.saveData();
            },
            
            removeRule(rule) {
                this.knowledgeBase.rules = this.knowledgeBase.rules.filter(r => r.id !== rule.id);
                this.saveData();
            },
            
            addCondition(rule) {
                rule.if.push('доп_условие');
                this.saveData();
            },
            
            removeCondition(rule, idx) {
                rule.if.splice(idx, 1);
                this.saveData();
            },
            
            // Работа с фактами
            addFact() {
                const newId = Math.max(...this.knowledgeBase.facts.map(f => f.id), 0) + 1;
                this.knowledgeBase.facts.push({
                    id: newId,
                    name: 'новый_факт',
                    type: 'симптом',
                    category: 'аппаратный'
                });
                this.saveData();
            },
            
            removeFact(fact) {
                this.knowledgeBase.facts = this.knowledgeBase.facts.filter(f => f.id !== fact.id);
                this.saveData();
            },
            
            // Логический вывод
            runInference() {
                // Собираем все факты
                const allFacts = [...this.query.facts, ...this.query.customFacts];
                
                // Простой прямой вывод
                const conclusions = [];
                const chain = [];
                
                this.knowledgeBase.rules.forEach(rule => {
                    // Проверяем, выполняются ли все условия правила
                    const conditionsMet = rule.if.every(condition => 
                        allFacts.includes(condition)
                    );
                    
                    if (conditionsMet) {
                        conclusions.push({
                            conclusion: rule.then,
                            confidence: rule.confidence
                        });
                        
                        chain.push({
                            ruleId: rule.id,
                            conditions: [...rule.if],
                            conclusion: rule.then,
                            confidence: rule.confidence
                        });
                    }
                });
                
                // Если правил не сработало, используем нейросеть (если есть)
                if (conclusions.length === 0 && this.neuralNetwork) {
                    try {
                        const input = {};
                        allFacts.forEach(fact => {
                            input[fact] = 1;
                        });
                        
                        const nnOutput = this.neuralNetwork.run(input);
                        const topResult = Object.entries(nnOutput)
                            .sort((a, b) => b[1] - a[1])[0];
                        
                        if (topResult && topResult[1] > 0.5) {
                            conclusions.push({
                                conclusion: topResult[0],
                                confidence: topResult[1].toFixed(2)
                            });
                            
                            chain.push({
                                ruleId: 'NN',
                                conditions: allFacts,
                                conclusion: `Нейросеть: ${topResult[0]}`,
                                confidence: topResult[1].toFixed(2)
                            });
                        }
                    } catch (e) {
                        console.error('Ошибка нейросети:', e);
                    }
                }
                
                this.result = {
                    executed: true,
                    conclusions: conclusions,
                    chain: chain
                };
            },
            
            addCustomFact() {
                if (this.newFactInput && this.newFactInput.trim()) {
                    this.query.customFacts.push(this.newFactInput.trim());
                    this.newFactInput = '';
                }
            },
            
            removeCustomFact(idx) {
                this.query.customFacts.splice(idx, 1);
            },
            
            // Методы для нейросети
            trainNeuralNetwork() {
                this.training = true;
                this.neuralResult = null;
                
                setTimeout(() => {
                    try {
                        const data = JSON.parse(this.neuralTrainingData);
                        
                        // Создаем и конфигурируем сеть
                        const net = new brain.NeuralNetwork({
                            hiddenLayers: eval(this.neuralConfig.hiddenLayers)
                        });
                        
                        // Обучаем
                        const result = net.train(data, {
                            iterations: this.neuralConfig.iterations,
                            log: true,
                            logPeriod: 100
                        });
                        
                        this.neuralNetwork = net;
                        this.neuralResult = result;
                        
                        // Сохраняем сеть
                        this.neuralNetworks.push({
                            id: Date.now(),
                            data: net.toJSON(),
                            trainedAt: new Date().toLocaleString()
                        });
                        
                        this.saveData();
                        
                    } catch (error) {
                        alert('Ошибка при обучении: ' + error.message);
                    } finally {
                        this.training = false;
                    }
                }, 100);
            },
            
            runNeuralNetwork() {
                if (!this.neuralNetwork) {
                    alert('Сначала обучите нейросеть!');
                    return;
                }
                
                try {
                    const input = JSON.parse(this.neuralTestInput);
                    this.neuralTestResult = this.neuralNetwork.run(input);
                } catch (error) {
                    alert('Ошибка при тестировании: ' + error.message);
                }
            },
            
            loadNetwork(net) {
                const restoredNet = new brain.NeuralNetwork();
                restoredNet.fromJSON(net.data);
                this.neuralNetwork = restoredNet;
                alert('Сеть загружена!');
            },
            
            removeNetwork(idx) {
                this.neuralNetworks.splice(idx, 1);
                this.saveData();
            },
            
            // Импорт/экспорт
            updateExportPreview() {
                const data = {
                    project: this.project,
                    knowledgeBase: this.knowledgeBase,
                    neuralNetworks: this.neuralNetworks,
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                };
                this.exportPreview = JSON.stringify(data, null, 2);
            },
            
            exportData() {
                const data = {
                    project: this.project,
                    knowledgeBase: this.knowledgeBase,
                    neuralNetworks: this.neuralNetworks,
                    exportedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `expertSys_${this.project.name}_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Файл экспортирован!');
            },
            
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.importFileData = JSON.parse(e.target.result);
                        this.importStatus = `Файл "${file.name}" загружен. Правил: ${this.importFileData.knowledgeBase?.rules?.length || 0}`;
                    } catch (error) {
                        this.importStatus = `Ошибка чтения файла: ${error.message}`;
                        this.importFileData = null;
                    }
                };
                reader.readAsText(file);
            },
            
            importData() {
                if (!this.importFileData) {
                    alert('Сначала выберите файл!');
                    return;
                }
                
                if (confirm(`Вы уверены? Текущие данные будут ${this.importMode === 'replace' ? 'заменены' : 'дополнены'}.`)) {
                    // Создаем резервную копию при необходимости
                    if (document.getElementById('backupBeforeImport').checked) {
                        this.createBackup();
                    }
                    
                    // Применяем выбранный режим импорта
                    switch(this.importMode) {
                        case 'replace':
                            Object.assign(this, this.importFileData);
                            break;
                        case 'merge':
                            // Объединяем массивы, избегая дубликатов
                            if (this.importFileData.knowledgeBase) {
                                const kb = this.importFileData.knowledgeBase;
                                
                                // Объединяем правила
                                kb.rules.forEach(newRule => {
                                    if (!this.knowledgeBase.rules.some(r => r.id === newRule.id)) {
                                        this.knowledgeBase.rules.push(newRule);
                                    }
                                });
                                
                                // Объединяем факты
                                kb.facts.forEach(newFact => {
                                    if (!this.knowledgeBase.facts.some(f => f.id === newFact.id)) {
                                        this.knowledgeBase.facts.push(newFact);
                                    }
                                });
                            }
                            break;
                        case 'append':
                            // Просто добавляем с новыми ID
                            if (this.importFileData.knowledgeBase) {
                                const kb = this.importFileData.knowledgeBase;
                                
                                // Добавляем правила с новыми ID
                                let maxRuleId = Math.max(...this.knowledgeBase.rules.map(r => r.id), 0);
                                kb.rules.forEach(rule => {
                                    this.knowledgeBase.rules.push({
                                        ...rule,
                                        id: ++maxRuleId
                                    });
                                });
                                
                                // Добавляем факты с новыми ID
                                let maxFactId = Math.max(...this.knowledgeBase.facts.map(f => f.id), 0);
                                kb.facts.forEach(fact => {
                                    this.knowledgeBase.facts.push({
                                        ...fact,
                                        id: ++maxFactId
                                    });
                                });
                            }
                            break;
                    }
                    
                    this.saveData();
                    this.updateExportPreview();
                    this.importStatus = 'Данные успешно импортированы!';
                    this.activeTab = 'editor'; // Переключаемся на редактор
                }
            },
            
            createBackup() {
                const backup = {
                    project: {...this.project},
                    knowledgeBase: {
                        ontology: [...this.knowledgeBase.ontology],
                        rules: [...this.knowledgeBase.rules],
                        facts: [...this.knowledgeBase.facts]
                    },
                    neuralNetworks: [...this.neuralNetworks],
                    backedUpAt: new Date().toISOString()
                };
                
                localStorage.setItem('expertSysBackup', JSON.stringify(backup));
                console.log('Резервная копия создана');
            },
            
            saveData() {
                const data = {
                    project: this.project,
                    knowledgeBase: this.knowledgeBase,
                    neuralNetworks: this.neuralNetworks,
                    neuralTrainingData: this.neuralTrainingData,
                    neuralConfig: this.neuralConfig
                };
                localStorage.setItem('expertSysData', JSON.stringify(data));
                const now = new Date().toLocaleTimeString();
                this.lastSaveTime = now;
                localStorage.setItem('expertSysLastSave', now);
                this.updateExportPreview();
            },
            
            loadFromStorage() {
                const saved = localStorage.getItem('expertSysData');
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(this, data);
                    this.updateExportPreview();
                    alert('Данные загружены из LocalStorage!');
                } else {
                    alert('Нет сохраненных данных.');
                }
            },
            
            clearData() {
                if (confirm('ВНИМАНИЕ! Это удалит ВСЕ данные. Продолжить?')) {
                    this.project = {
                        name: 'Новый проект',
                        description: '',
                        domain: ''
                    };
                    this.knowledgeBase = {
                        ontology: [],
                        rules: [],
                        facts: []
                    };
                    this.neuralNetworks = [];
                    this.query = { facts: [], customFacts: [] };
                    this.result = { executed: false, conclusions: [], chain: [] };
                    
                    localStorage.removeItem('expertSysData');
                    this.updateExportPreview();
                    alert('Все данные очищены.');
                }
            },
            
            loadExample(type) {
                const examples = {
                    medical: {
                        project: {
                            name: 'Медицинская диагностика',
                            description: 'Экспертная система для предварительной диагностики',
                            domain: 'Медицина'
                        },
                        knowledgeBase: {
                            ontology: [
                                { id: 1, name: 'Пациент', attributes: ['возраст', 'пол', 'вес'] },
                                { id: 2, name: 'Симптом', attributes: ['локализация', 'интенсивность', 'длительность'] }
                            ],
                            rules: [
                                { id: 1, if: ['высокая_температура', 'кашель'], then: 'возможен_грипп', confidence: 0.7 },
                                { id: 2, if: ['головная_боль', 'тошнота'], then: 'проверить_давление', confidence: 0.8 }
                            ],
                            facts: [
                                { id: 1, name: 'высокая_температура', type: 'симптом', category: 'общий' },
                                { id: 2, name: 'кашель', type: 'симптом', category: 'респираторный' }
                            ]
                        }
                    },
                    it: {
                        project: {
                            name: 'IT-поддержка',
                            description: 'Диагностика компьютерных проблем',
                            domain: 'Информационные технологии'
                        },
                        knowledgeBase: {
                            ontology: [
                                { id: 1, name: 'Оборудование', attributes: ['тип', 'состояние', 'возраст'] },
                                { id: 2, name: 'Проблема', attributes: ['категория', 'приоритет', 'статус'] }
                            ],
                            rules: [
                                { id: 1, if: ['нет_интернета', 'горит_красный_индикатор'], then: 'проверить_кабель', confidence: 0.9 },
                                { id: 2, if: ['медленная_загрузка', 'мало_свободного_места'], then: 'очистить_диск', confidence: 0.75 }
                            ],
                            facts: [
                                { id: 1, name: 'нет_интернета', type: 'симптом', category: 'сеть' },
                                { id: 2, name: 'медленная_загрузка', type: 'симптом', category: 'производительность' }
                            ]
                        }
                    }
                };
                
                if (examples[type]) {
                    Object.assign(this, examples[type]);
                    this.saveData();
                    this.updateExportPreview();
                    alert(`Загружен пример: ${examples[type].project.name}`);
                }
            }
        }
    }
    </script>
</body>
</html>
