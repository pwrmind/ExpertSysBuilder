<!DOCTYPE html>
<html lang="ru" x-data="appData()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExpertSys Builder - Среда разработки экспертных систем</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/brain.js/2.0.0-beta.24/browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root { --bs-font-sans-serif: 'Inter', sans-serif; --bs-body-font-size: 0.875rem; }
        .code-font { font-family: 'Roboto Mono', monospace; font-size: 0.8rem; }
        .compact .form-control, .compact .btn, .compact .input-group-text { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        .module-card { transition: all 0.2s; border-left: 4px solid #0d6efd; }
        .module-card:hover { transform: translateY(-2px); box-shadow: 0 .3rem .75rem rgba(0,0,0,.1); }
        .rule-badge { font-size: 0.7rem; }
        .nav-tabs .nav-link { font-size: 0.85rem; padding: 0.5rem 0.75rem; }
        .tab-content { padding-top: 1rem; }
        .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; }
        .timeline { position: relative; padding-left: 20px; }
        .timeline-item { position: relative; margin-bottom: 15px; }
        .timeline-marker { position: absolute; left: -20px; top: 10px; width: 10px; height: 10px; border-radius: 50%; }
        .timeline-content { margin-left: 10px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .attribute-input { border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.25rem; }
    </style>
</head>
<body class="bg-light compact">
    <div class="container-fluid py-2">
        <div id="app" x-data="appData()" x-init="init()">
            <header class="mb-3 border-bottom pb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h4 mb-0"><i class="bi bi-cpu"></i> ExpertSys Builder</h1>
                        <small class="text-muted">Среда разработки экспертных систем с ИИ</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-info me-2" x-text="`Правил: ${knowledgeBase.rules.length}`"></span>
                        <span class="badge bg-success" x-text="`Фактов: ${knowledgeBase.facts.length}`"></span>
                        <span class="badge bg-warning ms-2" x-text="`Классов: ${knowledgeBase.ontology.length}`"></span>
                    </div>
                </div>
                
                <ul class="nav nav-tabs mt-3">
                    <template x-for="tab in tabs" :key="tab.id">
                        <li class="nav-item">
                            <a class="nav-link" :class="{ 'active': activeTab === tab.id }" href="#" 
                               @click.prevent="switchTab(tab.id)">
                                <i :class="tab.icon"></i> <span x-text="tab.name"></span>
                            </a>
                        </li>
                    </template>
                </ul>
            </header>

            <main>
                <!-- Модуль редактора БЗ -->
                <div x-show="activeTab === 'editor'">
                    <div class="row g-3">
                        <!-- Колонка 1: Онтология -->
                        <div class="col-lg-4">
                            <div class="card module-card h-100">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-diagram-2"></i> Онтология (Классы)</h6>
                                    <button class="btn btn-sm btn-success" @click="addClass">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body p-2">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Имя класса</th>
                                                    <th>Атрибуты</th>
                                                    <th>Экземпляры</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="cls in knowledgeBase.ontology" :key="cls.id">
                                                    <tr>
                                                        <td x-text="cls.id" class="fw-bold"></td>
                                                        <td>
                                                            <input type="text" class="form-control form-control-sm border-0 p-0" 
                                                                   x-model="cls.name" @input="saveData">
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-wrap gap-1">
                                                                <template x-for="(attr, idx) in cls.attributes" :key="idx">
                                                                    <span class="badge bg-secondary rule-badge" x-text="attr"></span>
                                                                </template>
                                                                <button class="btn btn-xs btn-outline-secondary" 
                                                                        @click="addAttribute(cls)">
                                                                    <i class="bi bi-plus"></i>
                                                                </button>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-info" 
                                                                  x-text="getInstancesCount(cls.id)"></span>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-danger" @click="removeClass(cls)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Колонка 2: Правила с поддержкой онтологии -->
                        <div class="col-lg-4">
                            <div class="card module-card h-100">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-list-check"></i> Правила (IF-THEN)</h6>
                                    <button class="btn btn-sm btn-success" @click="addRule">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body p-2">
                                    <div class="accordion" id="rulesAccordion">
                                        <template x-for="(rule, index) in knowledgeBase.rules" :key="rule.id">
                                            <div class="accordion-item border-0 mb-2">
                                                <h6 class="accordion-header">
                                                    <button class="accordion-button collapsed py-1" type="button" 
                                                            data-bs-toggle="collapse" :data-bs-target="'#rule' + rule.id"
                                                            @click="toggleRule(rule.id)">
                                                        <span class="badge bg-primary me-2" x-text="'#' + rule.id"></span>
                                                        <small class="truncate" x-text="getRulePreview(rule)"></small>
                                                    </button>
                                                </h6>
                                                <div :id="'rule' + rule.id" class="accordion-collapse collapse">
                                                    <div class="accordion-body p-2">
                                                        <div class="mb-2">
                                                            <label class="form-label small">Тип правила:</label>
                                                            <select class="form-select form-select-sm" x-model="rule.type" @change="saveData">
                                                                <option value="simple">Простое (текстовое)</option>
                                                                <option value="ontology">С использованием онтологии</option>
                                                            </select>
                                                        </div>
                                                        
                                                        <div x-show="rule.type === 'simple'">
                                                            <div class="mb-2">
                                                                <label class="form-label small">Условие (IF):</label>
                                                                <div class="d-flex flex-wrap gap-1 mb-1">
                                                                    <template x-for="(condition, idx) in rule.if" :key="idx">
                                                                        <div class="input-group input-group-sm" style="width: auto">
                                                                            <input type="text" class="form-control" 
                                                                                   x-model="rule.if[idx]" @input="saveData">
                                                                            <button class="btn btn-outline-danger" 
                                                                                    @click="removeCondition(rule, idx)">
                                                                                <i class="bi bi-x"></i>
                                                                            </button>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                                <button class="btn btn-sm btn-outline-secondary" @click="addCondition(rule)">
                                                                    <i class="bi bi-plus-circle"></i> Добавить условие
                                                                </button>
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label small">Заключение (THEN):</label>
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       x-model="rule.then" @input="saveData">
                                                            </div>
                                                        </div>
                                                        
                                                        <div x-show="rule.type === 'ontology'">
                                                            <div class="mb-2">
                                                                <label class="form-label small">Условие с объектом:</label>
                                                                <div class="row g-2 mb-2">
                                                                    <div class="col-5">
                                                                        <select class="form-select form-select-sm" 
                                                                                x-model="rule.ontologyCondition.objectClass" 
                                                                                @change="updateRuleAttributes(rule)">
                                                                            <option value="">Выберите класс</option>
                                                                            <template x-for="cls in knowledgeBase.ontology" :key="cls.id">
                                                                                <option :value="cls.name" x-text="cls.name"></option>
                                                                            </template>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-4">
                                                                        <select class="form-select form-select-sm" 
                                                                                x-model="rule.ontologyCondition.attribute"
                                                                                :disabled="!rule.ontologyCondition.objectClass">
                                                                            <option value="">Атрибут</option>
                                                                            <template x-for="attr in getClassAttributes(rule.ontologyCondition.objectClass)" :key="attr">
                                                                                <option :value="attr" x-text="attr"></option>
                                                                            </template>
                                                                        </select>
                                                                    </div>
                                                                    <div class="col-3">
                                                                        <input type="text" class="form-control form-control-sm" 
                                                                               placeholder="Значение" 
                                                                               x-model="rule.ontologyCondition.value">
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="mb-2">
                                                                <label class="form-label small">Заключение:</label>
                                                                <input type="text" class="form-control form-control-sm" 
                                                                       x-model="rule.then" @input="saveData">
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mb-2">
                                                            <label class="form-label small">
                                                                Достоверность: <span x-text="rule.confidence"></span>
                                                            </label>
                                                            <input type="range" class="form-range" min="0" max="1" step="0.05" 
                                                                   x-model="rule.confidence" @input="saveData">
                                                        </div>
                                                        <div class="d-flex justify-content-between">
                                                            <button class="btn btn-sm btn-danger" @click="removeRule(rule)">
                                                                <i class="bi bi-trash"></i> Удалить
                                                            </button>
                                                            <span class="text-muted small" x-text="'ID: ' + rule.id"></span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Колонка 3: Факты с привязкой к онтологии -->
                        <div class="col-lg-4">
                            <div class="card module-card h-100">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-card-checklist"></i> Факты (экземпляры классов)</h6>
                                    <button class="btn btn-sm btn-success" @click="showAddFactModal">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                                <div class="card-body p-2">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Имя</th>
                                                    <th>Класс</th>
                                                    <th>Атрибуты</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <template x-for="fact in knowledgeBase.facts" :key="fact.id">
                                                    <tr>
                                                        <td x-text="fact.id" class="fw-bold"></td>
                                                        <td>
                                                            <span x-text="fact.name"></span>
                                                            <br>
                                                            <small class="text-muted" x-text="fact.type"></small>
                                                        </td>
                                                        <td>
                                                            <span class="badge bg-primary" x-text="fact.className || 'нет'"></span>
                                                        </td>
                                                        <td>
                                                            <div class="d-flex flex-wrap gap-1">
                                                                <template x-for="(value, key) in fact.attributes" :key="key">
                                                                    <span class="badge bg-secondary rule-badge" 
                                                                          x-text="key + ': ' + value"></span>
                                                                </template>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <button class="btn btn-sm btn-outline-danger" @click="removeFact(fact)">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модуль логического вывода с онтологией -->
                <div x-show="activeTab === 'inference'">
                    <div class="row g-3">
                        <div class="col-md-5">
                            <div class="card module-card">
                                <div class="card-header py-2">
                                    <h6 class="mb-0"><i class="bi bi-chat-left-text"></i> Ввод запроса</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">Режим запроса:</label>
                                        <select class="form-select form-select-sm mb-2" x-model="inferenceMode">
                                            <option value="simple">Простой (факты)</option>
                                            <option value="ontology">С онтологией (объекты)</option>
                                        </select>
                                    </div>
                                    
                                    <div x-show="inferenceMode === 'simple'">
                                        <label class="form-label small">Выберите известные факты:</label>
                                        <div class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto;">
                                            <template x-for="fact in knowledgeBase.facts" :key="fact.id">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" :id="'fact_' + fact.id" 
                                                           :value="fact.name" x-model="query.facts">
                                                    <label class="form-check-label small" :for="'fact_' + fact.id" 
                                                           x-text="fact.name + (fact.className ? ' (' + fact.className + ')' : '')"></label>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <div x-show="inferenceMode === 'ontology'">
                                        <label class="form-label small">Выберите объекты и их состояния:</label>
                                        <div class="border rounded p-2 bg-light" style="max-height: 200px; overflow-y: auto;">
                                            <template x-for="fact in knowledgeBase.facts.filter(f => f.className)" :key="fact.id">
                                                <div class="mb-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" 
                                                               :id="'obj_' + fact.id" 
                                                               :value="fact.name" 
                                                               x-model="query.ontologyObjects">
                                                        <label class="form-check-label small fw-bold" :for="'obj_' + fact.id" 
                                                               x-text="fact.name + ' (' + fact.className + ')'"></label>
                                                    </div>
                                                    <div class="ms-3">
                                                        <template x-for="(value, key) in fact.attributes" :key="key">
                                                            <div class="form-check form-check-inline">
                                                                <input class="form-check-input" type="checkbox" 
                                                                       :id="'attr_' + fact.id + '_' + key"
                                                                       :value="fact.name + '.' + key + '=' + value"
                                                                       x-model="query.ontologyAttributes">
                                                                <label class="form-check-label small" 
                                                                       :for="'attr_' + fact.id + '_' + key"
                                                                       x-text="key + ': ' + value"></label>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-primary w-100" @click="runInference">
                                            <i class="bi bi-play-circle"></i> Запустить логический вывод
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card module-card mt-3" x-show="result.conclusions.length > 0">
                                <div class="card-header py-2 bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-check-circle"></i> Результаты вывода</h6>
                                </div>
                                <div class="card-body">
                                    <h6 class="border-bottom pb-1">Найденные решения:</h6>
                                    <ul class="list-group list-group-flush">
                                        <template x-for="(conc, idx) in result.conclusions" :key="idx">
                                            <li class="list-group-item py-1 d-flex justify-content-between">
                                                <span x-text="conc.conclusion"></span>
                                                <span class="badge bg-success" x-text="'Вер. ' + conc.confidence"></span>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-7">
                            <div class="card module-card h-100">
                                <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="bi bi-list-columns-reverse"></i> Процесс логического вывода</h6>
                                </div>
                                <div class="card-body">
                                    <div x-show="!result.executed" class="text-center text-muted py-5">
                                        <i class="bi bi-arrow-left display-6"></i>
                                        <p class="mt-2">Введите факты и запустите вывод</p>
                                    </div>
                                    
                                    <div x-show="result.executed">
                                        <h6 class="border-bottom pb-1">Цепочка рассуждений:</h6>
                                        <div class="timeline mt-3">
                                            <template x-for="(step, idx) in result.chain" :key="idx">
                                                <div class="timeline-item mb-3">
                                                    <div class="timeline-marker bg-primary"></div>
                                                    <div class="timeline-content">
                                                        <div class="card">
                                                            <div class="card-body py-2">
                                                                <div class="d-flex justify-content-between">
                                                                    <small class="text-muted" 
                                                                           x-text="'Шаг ' + (idx + 1) + ' (Правило #' + step.ruleId + ')'"></small>
                                                                    <span class="badge bg-primary" 
                                                                          x-text="'Вер. ' + step.confidence"></span>
                                                                </div>
                                                                <div class="mt-1">
                                                                    <template x-if="step.type === 'ontology'">
                                                                        <div>
                                                                            <span class="fw-bold" x-text="'ЕСЛИ ' + step.conditionText"></span>
                                                                            <br>
                                                                            <span class="text-success" x-text="'ТО ' + step.conclusion"></span>
                                                                        </div>
                                                                    </template>
                                                                    <template x-if="step.type !== 'ontology'">
                                                                        <div>
                                                                            <span class="fw-bold" x-text="'ЕСЛИ ' + step.conditions.join(' И ')"></span>
                                                                            <br>
                                                                            <span class="text-success" x-text="'ТО ' + step.conclusion"></span>
                                                                        </div>
                                                                    </template>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модальное окно для добавления факта -->
                <div class="modal fade" id="addFactModal" tabindex="-1" aria-labelledby="addFactModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="addFactModalLabel">Добавить новый факт</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Имя факта:</label>
                                    <input type="text" class="form-control" x-model="newFact.name" placeholder="например: компьютер_офисный">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Тип:</label>
                                    <select class="form-select" x-model="newFact.type">
                                        <option value="объект">Объект</option>
                                        <option value="свойство">Свойство</option>
                                        <option value="отношение">Отношение</option>
                                        <option value="симптом">Симптом</option>
                                        <option value="диагноз">Диагноз</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Категория:</label>
                                    <select class="form-select" x-model="newFact.category">
                                        <option value="аппаратный">Аппаратный</option>
                                        <option value="программный">Программный</option>
                                        <option value="сетевой">Сетевой</option>
                                        <option value="общий">Общий</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Класс (из онтологии):</label>
                                    <select class="form-select" x-model="newFact.className" @change="updateAttributesForClass">
                                        <option value="">-- Выберите класс --</option>
                                        <template x-for="cls in knowledgeBase.ontology" :key="cls.id">
                                            <option :value="cls.name" x-text="cls.name"></option>
                                        </template>
                                    </select>
                                    <small class="text-muted" x-show="newFact.className">
                                        Атрибуты класса: <span x-text="getClassAttributesText(newFact.className)"></span>
                                    </small>
                                </div>
                                
                                <div class="mb-3" x-show="newFact.className">
                                    <label class="form-label">Атрибуты объекта:</label>
                                    <div class="border rounded p-3">
                                        <template x-for="attr in getClassAttributes(newFact.className)" :key="attr">
                                            <div class="row mb-2">
                                                <div class="col-4">
                                                    <label class="form-label small" x-text="attr"></label>
                                                </div>
                                                <div class="col-8">
                                                    <input type="text" class="form-control form-control-sm" 
                                                           x-model="newFact.attributes[attr]" 
                                                           :placeholder="'Значение для ' + attr">
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                <button type="button" class="btn btn-primary" @click="addFact" data-bs-dismiss="modal">
                                    Добавить факт
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Остальные вкладки (нейросеть, импорт/экспорт, проект) остаются без изменений -->
                <!-- Модуль нейросети -->
                <div x-show="activeTab === 'neural'">
                    <!-- Содержимое нейросети без изменений -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-header py-2">
                                    <h6 class="mb-0"><i class="bi bi-cpu"></i> Обучение нейросети (Brain.js)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">Тренировочные данные (JSON):</label>
                                        <textarea class="form-control code-font" rows="10" x-model="neuralTrainingData"></textarea>
                                    </div>
                                    <button class="btn btn-primary w-100 mt-3" @click="trainNeuralNetwork">
                                        <i class="bi bi-play-fill"></i> Обучить нейросеть
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-header py-2">
                                    <h6 class="mb-0"><i class="bi bi-lightning-charge"></i> Тестирование нейросети</h6>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-success w-100" @click="runNeuralNetwork">
                                        <i class="bi bi-gear"></i> Запустить классификацию
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модуль импорта/экспорта -->
                <div x-show="activeTab === 'io'">
                    <!-- Содержимое импорта/экспорта без изменений -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-header py-2 bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-download"></i> Экспорт базы знаний</h6>
                                </div>
                                <div class="card-body">
                                    <button class="btn btn-success w-100" @click="exportData">
                                        <i class="bi bi-file-arrow-down"></i> Скачать файл экспорта
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-header py-2 bg-warning text-dark">
                                    <h6 class="mb-0"><i class="bi bi-upload"></i> Импорт базы знаний</h6>
                                </div>
                                <div class="card-body">
                                    <input type="file" class="form-control form-control-sm mb-3" @change="handleFileSelect">
                                    <button class="btn btn-warning w-100" @click="importData">
                                        <i class="bi bi-file-arrow-up"></i> Импортировать данные
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Модуль проекта -->
                <div x-show="activeTab === 'project'">
                    <h2 class="h5 mb-3"><i class="bi bi-folder"></i> Проект и настройки</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-info-circle"></i> Информация о проекте</h6>
                                    <div class="mb-2">
                                        <label class="form-label small">Название проекта</label>
                                        <input type="text" class="form-control form-control-sm" x-model="project.name" @input="saveData">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card module-card">
                                <div class="card-body">
                                    <h6 class="card-title"><i class="bi bi-graph-up"></i> Статистика</h6>
                                    <ul class="list-group list-group-flush small">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Правил в БЗ</span>
                                            <span class="badge bg-primary rounded-pill" x-text="knowledgeBase.rules.length"></span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Фактов в БЗ</span>
                                            <span class="badge bg-primary rounded-pill" x-text="knowledgeBase.facts.length"></span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <span>Классов онтологии</span>
                                            <span class="badge bg-primary rounded-pill" x-text="knowledgeBase.ontology.length"></span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    function appData() {
        return {
            activeTab: 'editor',
            tabs: [
                { id: 'editor', name: 'Редактор БЗ', icon: 'bi bi-pencil-square' },
                { id: 'inference', name: 'Вывод', icon: 'bi bi-gear' },
                { id: 'neural', name: 'Нейросеть', icon: 'bi bi-diagram-3' },
                { id: 'io', name: 'Импорт/Экспорт', icon: 'bi bi-arrow-left-right' },
                { id: 'project', name: 'Проект', icon: 'bi bi-folder' }
            ],
            
            project: {
                name: 'Моя экспертная система',
                description: 'Демонстрационный проект диагностики проблем с ПК',
                domain: 'IT-диагностика'
            },
            
            knowledgeBase: {
                ontology: [
                    { id: 1, name: 'Компьютер', attributes: ['модель', 'состояние', 'процессор', 'оперативная_память'] },
                    { id: 2, name: 'Принтер', attributes: ['марка', 'статус', 'тип_печати'] },
                    { id: 3, name: 'Сетевое_оборудование', attributes: ['тип', 'ip_адрес', 'статус'] }
                ],
                rules: [
                    { 
                        id: 1, 
                        type: 'simple',
                        if: ['компьютер_не_включается'], 
                        then: 'проверить_питание', 
                        confidence: 0.9 
                    },
                    { 
                        id: 2, 
                        type: 'simple',
                        if: ['синий_экран', 'перезагрузка'], 
                        then: 'проверить_оперативную_память', 
                        confidence: 0.85 
                    },
                    { 
                        id: 3, 
                        type: 'ontology',
                        ontologyCondition: {
                            objectClass: 'Компьютер',
                            attribute: 'состояние',
                            value: 'медленно_работает'
                        },
                        then: 'очистить_временные_файлы', 
                        confidence: 0.7 
                    }
                ],
                facts: [
                    { 
                        id: 1, 
                        name: 'компьютер_офисный', 
                        type: 'объект', 
                        category: 'техника',
                        className: 'Компьютер',
                        attributes: {
                            'модель': 'Dell Optiplex',
                            'состояние': 'рабочий',
                            'процессор': 'Intel i5',
                            'оперативная_память': '8GB'
                        }
                    },
                    { 
                        id: 2, 
                        name: 'принтер_кабинет101', 
                        type: 'объект', 
                        category: 'техника',
                        className: 'Принтер',
                        attributes: {
                            'марка': 'HP LaserJet',
                            'статус': 'не_печатает',
                            'тип_печати': 'лазерный'
                        }
                    },
                    { 
                        id: 3, 
                        name: 'компьютер_не_включается', 
                        type: 'симптом', 
                        category: 'аппаратный'
                    },
                    { 
                        id: 4, 
                        name: 'синий_экран', 
                        type: 'симптом', 
                        category: 'программный'
                    }
                ]
            },
            
            query: {
                facts: [],
                ontologyObjects: [],
                ontologyAttributes: []
            },
            result: {
                executed: false,
                conclusions: [],
                chain: []
            },
            inferenceMode: 'simple',
            
            newFact: {
                name: '',
                type: 'объект',
                category: 'аппаратный',
                className: '',
                attributes: {}
            },
            
            neuralTrainingData: `[
  {"input": {"компьютер_не_включается": 1}, "output": {"проблема_питания": 1}},
  {"input": {"синий_экран": 1, "перезагрузка": 1}, "output": {"проблема_памяти": 1}}
]`,
            neuralNetwork: null,
            
            init() {
                const saved = localStorage.getItem('expertSysData');
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        Object.assign(this, data);
                    } catch(e) {
                        console.error('Ошибка загрузки:', e);
                    }
                }
            },
            
            // Методы работы с онтологией
            addClass() {
                const newId = Math.max(...this.knowledgeBase.ontology.map(c => c.id), 0) + 1;
                this.knowledgeBase.ontology.push({
                    id: newId,
                    name: 'НовыйКласс',
                    attributes: []
                });
                this.saveData();
            },
            
            removeClass(cls) {
                // Удаляем факты, связанные с этим классом
                this.knowledgeBase.facts = this.knowledgeBase.facts.filter(f => f.className !== cls.name);
                this.knowledgeBase.ontology = this.knowledgeBase.ontology.filter(c => c.id !== cls.id);
                this.saveData();
            },
            
            addAttribute(cls) {
                const attrName = prompt('Введите имя атрибута:');
                if (attrName && attrName.trim()) {
                    cls.attributes.push(attrName.trim());
                    this.saveData();
                }
            },
            
            getInstancesCount(classId) {
                const className = this.knowledgeBase.ontology.find(c => c.id === classId)?.name;
                if (!className) return 0;
                return this.knowledgeBase.facts.filter(f => f.className === className).length;
            },
            
            getClassAttributes(className) {
                const cls = this.knowledgeBase.ontology.find(c => c.name === className);
                return cls ? cls.attributes : [];
            },
            
            getClassAttributesText(className) {
                return this.getClassAttributes(className).join(', ');
            },
            
            // Методы работы с фактами
            showAddFactModal() {
                this.newFact = {
                    name: '',
                    type: 'объект',
                    category: 'аппаратный',
                    className: '',
                    attributes: {}
                };
                const modal = new bootstrap.Modal(document.getElementById('addFactModal'));
                modal.show();
            },
            
            updateAttributesForClass() {
                if (this.newFact.className) {
                    const attributes = this.getClassAttributes(this.newFact.className);
                    this.newFact.attributes = {};
                    attributes.forEach(attr => {
                        this.newFact.attributes[attr] = '';
                    });
                }
            },
            
            addFact() {
                const newId = Math.max(...this.knowledgeBase.facts.map(f => f.id), 0) + 1;
                const fact = {
                    id: newId,
                    name: this.newFact.name,
                    type: this.newFact.type,
                    category: this.newFact.category,
                    className: this.newFact.className,
                    attributes: {...this.newFact.attributes}
                };
                this.knowledgeBase.facts.push(fact);
                this.saveData();
            },
            
            removeFact(fact) {
                this.knowledgeBase.facts = this.knowledgeBase.facts.filter(f => f.id !== fact.id);
                this.saveData();
            },
            
            // Методы работы с правилами
            addRule() {
                const newId = Math.max(...this.knowledgeBase.rules.map(r => r.id), 0) + 1;
                this.knowledgeBase.rules.push({
                    id: newId,
                    type: 'simple',
                    if: ['новое_условие'],
                    then: 'новое_заключение',
                    confidence: 0.8,
                    ontologyCondition: {
                        objectClass: '',
                        attribute: '',
                        value: ''
                    }
                });
                this.saveData();
            },
            
            removeRule(rule) {
                this.knowledgeBase.rules = this.knowledgeBase.rules.filter(r => r.id !== rule.id);
                this.saveData();
            },
            
            addCondition(rule) {
                if (rule.type === 'simple') {
                    rule.if.push('доп_условие');
                    this.saveData();
                }
            },
            
            removeCondition(rule, idx) {
                if (rule.type === 'simple') {
                    rule.if.splice(idx, 1);
                    this.saveData();
                }
            },
            
            updateRuleAttributes(rule) {
                rule.ontologyCondition.attribute = '';
                this.saveData();
            },
            
            getRulePreview(rule) {
                if (rule.type === 'simple') {
                    if (!rule.if || !rule.then) return 'Пустое правило';
                    return rule.if.join(' И ') + ' → ' + rule.then;
                } else {
                    const cond = rule.ontologyCondition;
                    if (!cond.objectClass || !cond.attribute) return 'Правило с онтологией';
                    return `${cond.objectClass}.${cond.attribute} = ${cond.value} → ${rule.then}`;
                }
            },
            
            // Логический вывод
            runInference() {
                const allFacts = [...this.query.facts];
                const conclusions = [];
                const chain = [];
                
                if (this.inferenceMode === 'ontology') {
                    // Добавляем атрибуты объектов как факты
                    this.query.ontologyAttributes.forEach(attrFact => {
                        allFacts.push(attrFact);
                    });
                }
                
                this.knowledgeBase.rules.forEach(rule => {
                    let conditionsMet = false;
                    
                    if (rule.type === 'simple') {
                        conditionsMet = rule.if.every(condition => 
                            allFacts.includes(condition)
                        );
                    } else if (rule.type === 'ontology') {
                        const cond = rule.ontologyCondition;
                        if (cond.objectClass && cond.attribute && cond.value) {
                            // Ищем объекты указанного класса
                            const objects = this.knowledgeBase.facts.filter(f => 
                                f.className === cond.objectClass && 
                                f.attributes && 
                                f.attributes[cond.attribute] === cond.value
                            );
                            
                            // Проверяем, есть ли такие объекты в запросе
                            conditionsMet = objects.some(obj => 
                                this.query.ontologyObjects.includes(obj.name) ||
                                this.query.ontologyAttributes.includes(`${obj.name}.${cond.attribute}=${cond.value}`)
                            );
                        }
                    }
                    
                    if (conditionsMet) {
                        conclusions.push({
                            conclusion: rule.then,
                            confidence: rule.confidence
                        });
                        
                        chain.push({
                            ruleId: rule.id,
                            type: rule.type,
                            conditions: rule.type === 'simple' ? [...rule.if] : [],
                            conditionText: rule.type === 'ontology' ? 
                                `${rule.ontologyCondition.objectClass}.${rule.ontologyCondition.attribute} = ${rule.ontologyCondition.value}` : 
                                '',
                            conclusion: rule.then,
                            confidence: rule.confidence
                        });
                    }
                });
                
                this.result = {
                    executed: true,
                    conclusions: conclusions,
                    chain: chain
                };
            },
            
            // Сохранение данных
            saveData() {
                const data = {
                    project: this.project,
                    knowledgeBase: this.knowledgeBase
                };
                localStorage.setItem('expertSysData', JSON.stringify(data));
            },
            
            // Импорт/экспорт
            exportData() {
                const data = {
                    project: this.project,
                    knowledgeBase: this.knowledgeBase,
                    exportedAt: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `expertSys_${this.project.name.replace(/\s+/g, '_')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Файл экспортирован!');
            },
            
            handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.project) this.project = data.project;
                        if (data.knowledgeBase) this.knowledgeBase = data.knowledgeBase;
                        alert('Данные импортированы!');
                    } catch (error) {
                        alert('Ошибка чтения файла: ' + error.message);
                    }
                };
                reader.readAsText(file);
            },
            
            importData() {
                if (confirm('Импортировать данные? Текущие данные будут заменены.')) {
                    // Здесь можно добавить логику импорта из выбранного файла
                    alert('Для импорта выберите файл выше');
                }
            },
            
            // Методы нейросети
            trainNeuralNetwork() {
                try {
                    const data = JSON.parse(this.neuralTrainingData);
                    const net = new brain.NeuralNetwork();
                    net.train(data);
                    this.neuralNetwork = net;
                    alert('Нейросеть обучена!');
                } catch (error) {
                    alert('Ошибка при обучении: ' + error.message);
                }
            },
            
            runNeuralNetwork() {
                if (!this.neuralNetwork) {
                    alert('Сначала обучите нейросеть!');
                    return;
                }
                alert('Функция тестирования нейросети в разработке');
            },
            
            // Вспомогательные методы
            switchTab(tabId) {
                this.activeTab = tabId;
            },
            
            toggleRule(ruleId) {
                console.log('Переключение правила:', ruleId);
            }
        }
    }
    </script>
</body>
</html>
